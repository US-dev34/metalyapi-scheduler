---
phase: 05-production-deployment
task: 6
total_tasks: 8
status: blocked
last_updated: 2026-02-21T12:12:39.705Z
---

<current_state>
All database and operational setup is complete. The app is fully functional locally (backend on port 8001, frontend on port 5173). Deployment to Railway + Vercel is blocked because the CLIs cannot authenticate from the Claude Code sandbox shell. The user needs to deploy from their own terminal or provide API tokens.
</current_state>

<completed_work>

- Task 1: Run all migrations (001-005) via Supabase SQL Editor - Done
  - Pasted 507-line ALL_MIGRATIONS.sql into Supabase SQL Editor via Playwright
  - 9 tables + 2 views + RLS policies + triggers all created
- Task 2: Get SUPABASE_SERVICE_KEY + update .env - Done
  - Found legacy service_role JWT from Supabase dashboard Settings > API > Legacy keys
  - Updated root .env with service_role key
- Task 3: Create admin user + project + membership - Done
  - Created admin@metalyapi.com (password: MetalYapi2026!) in Supabase Auth
  - User ID: 90b03855-ce4d-445d-bb92-4f383eb68634
  - Created E2NS project (ID: 5f0fc90a-00b7-4cf7-aaba-22dde8118fa1)
  - Created project_members entry (had to disable auto-admin trigger for SQL Editor context)
- Task 4: Import WBS data from Excel - Done
  - Read DATA/WBS_E2NS_D1D2_Restructured.xlsx (headers in row 4, data from row 5)
  - Wrote Python script using urllib to POST each item to /api/v1/wbs/{project_id}/items
  - 86 items imported, 9 duplicates skipped
- Task 5: Smoke test all features - Done
  - Login: PASS (Supabase Auth works)
  - Daily Grid: PASS (86 WBS items with real facade data)
  - Cell edit + save: PASS (entered 5 workers for FT07 Monday, persisted to DB)
  - Weekly View: PASS (KW columns, summary cards)
  - Summary View: PASS (KPI cards, full table)
  - Excel export: PASS (200 OK, 9409 bytes, correct MIME)
  - PDF export: PASS (200 OK, 11325 bytes, application/pdf)
  - Chat UI: PASS (panel opens, input works)
  - Chat NLP: EXPECTED FAIL (needs CLAUDE_API_KEY)
  - Console errors: 0
- Task 6: Deploy to Railway + Vercel - BLOCKED
  - Both CLIs require interactive browser login
  - Cannot authenticate from sandboxed shell

</completed_work>

<remaining_work>

- Task 6: Deploy backend to Railway
  - Run `railway login` from user's terminal
  - Run `railway init` to link project
  - Run `railway up` to deploy
  - Set env vars: SUPABASE_URL, SUPABASE_KEY, SUPABASE_SERVICE_KEY, CLAUDE_API_KEY, CORS_ORIGINS (with production frontend URL), ENVIRONMENT=production
- Task 7: Deploy frontend to Vercel
  - Run `vercel login` from user's terminal
  - Run `cd frontend && vercel --prod`
  - Set env vars: VITE_API_BASE_URL (Railway URL), VITE_SUPABASE_URL, VITE_SUPABASE_ANON_KEY
  - Update CORS_ORIGINS on Railway to include Vercel URL
- Task 8: Production smoke test
  - Verify all features work on deployed URLs
  - Set CLAUDE_API_KEY for AI features

</remaining_work>

<decisions_made>

- Backend on port 8001 locally (port 8000 stuck from stale process)
- frontend/.env changed to point to 8001 for local testing (needs to be production URL for deploy)
- WBS import done via API POST rather than file upload (Excel columns didn't match import endpoint expectations)
- Auto-admin trigger disabled for manual SQL inserts (auth.uid() is null in SQL Editor)
- Used legacy JWT service_role key (not new sb_secret_* format) because supabase-py expects JWT

</decisions_made>

<blockers>

- Railway CLI: `Unauthorized. Please login with railway login` - needs interactive browser auth
- Vercel CLI: `No existing credentials found` - needs interactive browser auth
- CLAUDE_API_KEY: Empty in .env - Chat NLP and AI forecast features won't work without it

</blockers>

<context>
The app is production-ready code-wise. All 5 phases of development are complete (bug fixes, auth, export/import, AI layer, deployment config). The database is fully set up with real WBS data from the E2NS facade construction project. The only remaining work is the actual deployment, which requires the user to authenticate Railway and Vercel CLIs from their own terminal.

Key files for deployment:
- railway.json (Dockerfile.backend, health check at /health)
- frontend/vercel.json (vite framework, SPA rewrite)
- .env (all backend credentials)
- frontend/.env (frontend env vars - VITE_API_BASE_URL needs to be updated to Railway URL)

Key identifiers:
- Supabase project ref: tfcmfbfnvrtsfqevwsko
- Admin user ID: 90b03855-ce4d-445d-bb92-4f383eb68634
- Admin email: admin@metalyapi.com
- E2NS project ID: 5f0fc90a-00b7-4cf7-aaba-22dde8118fa1
- Backend: http://localhost:8001
- Frontend: http://localhost:5173
</context>

<next_action>
Start with: Authenticate Railway CLI (`railway login`) and Vercel CLI (`vercel login`) from user's terminal, then run deployment commands. Or provide API tokens so Claude can deploy from its shell.
</next_action>
