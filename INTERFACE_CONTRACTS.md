# INTERFACE_CONTRACTS.md — Agent'lar Arası Sözleşmeler

**Proje:** MetalYapi Façade Scheduling Platform
**Versiyon:** 1.0
**Son Güncelleme:** 2026-02-20
**Yönetici:** Orchestrator Agent

---

## Genel Kurallar

1. Her contract bir **Producer** (üreten) ve bir veya birden fazla **Consumer** (tüketen) tanımlar
2. Producer contract'ı değiştirdiğinde → tüm Consumer'ları bilgilendirir (Orchestrator üzerinden)
3. Conflict durumunda → Producer'ın tanımı geçerlidir
4. Type mismatch → DB schema (IC-001) her zaman master'dır
5. Her contract bir **validation kuralı** içerir — üretilen veri bu kurala uymalıdır

---

## IC-001: DB Schema → TypeScript Types

- **Producer:** Agent 1 (DB)
- **Consumer:** Agent 2 (Backend), Agent 3 (Frontend)
- **Location:** `/src/types/database.ts` (auto-generated by Supabase CLI)
- **Update Rule:** Agent 1 schema değişirse → `supabase gen types typescript` → `src/types/database.ts` regenerate → Agent 2, 3 import'ları kontrol eder
- **Conflict Resolution:** DB schema is master. Backend Pydantic models ve Frontend TypeScript types DB schema'ya adapt olur.

### Core Type Definitions

```typescript
// === projects ===
interface Project {
  id: string;           // uuid
  name: string;
  code: string;         // unique
  start_date: string;   // YYYY-MM-DD
  end_date: string | null;
  status: 'active' | 'completed' | 'archived';
  created_at: string;   // ISO 8601
  updated_at: string;
}

// === wbs_items ===
interface WBSItem {
  id: string;           // uuid
  project_id: string;   // FK → projects.id
  parent_id: string | null; // FK → wbs_items.id (self-reference)
  wbs_code: string;     // unique per project
  wbs_name: string;
  qty: number;          // numeric(12,2)
  unit: string;         // default: 'pcs'
  sort_order: number;
  level: number;        // hierarchy depth (0 = root)
  is_summary: boolean;  // true = has children, aggregation row
  created_at: string;
  updated_at: string;
}

// === daily_allocations ===
interface DailyAllocation {
  id: string;           // uuid
  wbs_item_id: string;  // FK → wbs_items.id
  date: string;         // YYYY-MM-DD
  planned_manpower: number; // numeric(8,2)
  actual_manpower: number;  // numeric(8,2)
  qty_done: number;     // numeric(12,2)
  notes: string | null;
  source: 'grid' | 'chat'; // veri girişi kaynağı
  created_at: string;
  updated_at: string;
}

// === baselines ===
interface Baseline {
  id: string;
  project_id: string;
  version: number;      // unique per project
  name: string;
  approved_at: string | null;
  approved_by: string | null;
  notes: string | null;
  is_active: boolean;
  created_at: string;
  updated_at: string;
}

// === baseline_snapshots ===
interface BaselineSnapshot {
  id: string;
  baseline_id: string;  // FK → baselines.id
  wbs_item_id: string;  // FK → wbs_items.id
  total_manday: number;
  start_date: string | null;
  end_date: string | null;
  daily_plan: Record<string, number>; // {"2026-02-17": 5, "2026-02-18": 7}
  manpower_per_day: number;
  created_at: string;
  updated_at: string;
}

// === ai_forecasts ===
interface AIForecast {
  id: string;
  project_id: string;
  wbs_item_id: string;
  forecast_date: string;
  predicted_end_date: string | null;
  predicted_manday: number | null;
  confidence: number;   // 0.0 - 1.0
  reasoning: string | null;
  parameters: Record<string, unknown>;
  created_at: string;
}

// === chat_messages ===
interface ChatMessage {
  id: string;
  project_id: string;
  user_id: string | null;
  message: string;
  parsed_actions: ParsedAction[]; // JSONB
  applied: boolean;
  timestamp: string;
}

// === audit_log ===
interface AuditLog {
  id: string;
  table_name: string;
  record_id: string;
  action: 'insert' | 'update' | 'delete';
  old_values: Record<string, unknown> | null;
  new_values: Record<string, unknown> | null;
  user_id: string | null;
  timestamp: string;
}

// === vw_wbs_progress (view) ===
interface WBSProgress {
  id: string;
  wbs_code: string;
  wbs_name: string;
  qty: number;
  done: number;
  remaining: number;
  progress_pct: number;       // 0.0 - 100.0
  total_actual_manday: number;
  working_days: number;
  productivity_rate: number;  // qty/manday ratio
}
```

### Validation Rules
- `id`: UUID v4 format
- `date` fields: YYYY-MM-DD format
- `timestamp` fields: ISO 8601 format
- `qty`, `manpower`: non-negative numbers
- `progress_pct`: 0.0 to 100.0
- `confidence`: 0.0 to 1.0
- `source`: exactly 'grid' or 'chat'
- `status`: exactly 'active', 'completed', or 'archived'
- `action`: exactly 'insert', 'update', or 'delete'

---

## IC-002: Backend API → Frontend Client

- **Producer:** Agent 2 (Backend)
- **Consumer:** Agent 3 (Frontend)
- **Contract:** Pydantic models (BE) == TypeScript interfaces (FE) — aynı shape
- **Validation:** Backend Pydantic V2 ile validate eder, Frontend Zod ile validate edebilir
- **Versioning:** `/api/v1/` — breaking change olursa v2

### DailyMatrixResponse (Ana grid data)

```typescript
// GET /api/v1/allocations/{project_id}/daily?from=2026-02-17&to=2026-03-01

interface CellData {
  planned: number;     // baseline'dan (0 if no baseline)
  actual: number;      // actual_manpower (0 if empty)
  qty_done: number;    // qty_done for this cell
  is_future: boolean;  // date > today
}

interface DailyMatrixResponse {
  wbs_items: WBSProgress[];  // IC-001'deki WBSProgress
  date_range: string[];       // ["2026-02-17", "2026-02-18", ...]
  matrix: {
    [wbs_id: string]: {       // wbs_item UUID
      [date: string]: CellData // "2026-02-17" → CellData
    }
  };
  totals: {
    [date: string]: {
      planned: number;   // günlük toplam baseline adam
      actual: number;    // günlük toplam actual adam
    }
  };
}
```

**Mock Data Örneği:**
```json
{
  "wbs_items": [
    {
      "id": "aaa-111",
      "wbs_code": "CW-01",
      "wbs_name": "Curtain Wall Tip-1",
      "qty": 100,
      "done": 35,
      "remaining": 65,
      "progress_pct": 35.0,
      "total_actual_manday": 42,
      "working_days": 8,
      "productivity_rate": 0.833
    }
  ],
  "date_range": ["2026-02-17", "2026-02-18", "2026-02-19"],
  "matrix": {
    "aaa-111": {
      "2026-02-17": { "planned": 5, "actual": 6, "qty_done": 4, "is_future": false },
      "2026-02-18": { "planned": 5, "actual": 4, "qty_done": 3, "is_future": false },
      "2026-02-19": { "planned": 5, "actual": 0, "qty_done": 0, "is_future": true }
    }
  },
  "totals": {
    "2026-02-17": { "planned": 15, "actual": 18 },
    "2026-02-18": { "planned": 15, "actual": 12 },
    "2026-02-19": { "planned": 15, "actual": 0 }
  }
}
```

### AllocationBatchUpdate (Cell editing)

```typescript
// PUT /api/v1/allocations/{project_id}/daily

interface AllocationCell {
  wbs_id: string;              // wbs_item UUID
  date: string;                // YYYY-MM-DD
  actual_manpower?: number;    // null = don't update
  qty_done?: number;           // null = don't update
  notes?: string;              // optional note
}

interface AllocationBatchUpdateRequest {
  updates: AllocationCell[];
  source: 'grid' | 'chat';     // default: 'grid'
}

// Response: 200 OK
interface AllocationBatchUpdateResponse {
  updated_count: number;
  errors: {
    wbs_id: string;
    date: string;
    error: string;
  }[];
}
```

### WeeklyResponse

```typescript
// GET /api/v1/allocations/{project_id}/weekly

interface WeeklyResponse {
  current_week: {
    week_number: number;        // ISO week
    date_range: string[];       // Mon-Sun dates
    wbs_items: WBSProgress[];
    matrix: Record<string, Record<string, CellData>>;
    totals: Record<string, { planned: number; actual: number }>;
  };
  next_week: {
    week_number: number;
    date_range: string[];
    matrix: Record<string, Record<string, CellData>>; // forecast/plan data
    totals: Record<string, { planned: number; actual: number }>;
  };
  kpi: {
    planned_manday: number;
    actual_manday: number;
    delta_progress: number;     // actual - planned (%)
    avg_productivity: number;
  };
}
```

### SummaryResponse

```typescript
// GET /api/v1/allocations/{project_id}/summary

interface GanttBar {
  wbs_id: string;
  wbs_code: string;
  wbs_name: string;
  baseline_start: string | null;
  baseline_end: string | null;
  actual_start: string | null;
  actual_end: string | null;     // last working day
  forecast_end: string | null;   // predicted end
  progress_pct: number;
}

interface SummaryResponse {
  wbs_items: WBSProgress[];
  gantt_bars: GanttBar[];
  milestones: {
    name: string;
    date: string;
    status: 'upcoming' | 'met' | 'missed';
  }[];
  overall: {
    total_progress: number;
    total_planned_manday: number;
    total_actual_manday: number;
    project_health: 'on_track' | 'at_risk' | 'behind';
  };
}
```

### Error Response Format

```typescript
// Tüm API error'ları bu formatta:
interface ErrorResponse {
  error: string;        // Human readable message
  code: string;         // Machine readable error code
  details?: Record<string, unknown>; // Additional context
}

// HTTP 400: { error: "Invalid date format", code: "ALC_DATE_INVALID", details: { date: "abc" } }
// HTTP 404: { error: "Project not found", code: "PRJ_NOT_FOUND", details: { id: "xxx" } }
// HTTP 409: { error: "Baseline version conflict", code: "BSL_VERSION_CONFLICT" }
// HTTP 422: { error: "Negative manpower not allowed", code: "ALC_NEGATIVE_VALUE" }
// HTTP 503: { error: "AI service unavailable", code: "AI_UNAVAILABLE" }
```

---

## IC-003: AI Service → Backend/Frontend

- **Producer:** Agent 4 (AI)
- **Consumer:** Agent 2 (Backend), Agent 3 (Frontend)
- **Contract:** AI service response formats
- **Fallback:** AI unavailable → backend returns error code `AI_UNAVAILABLE` → frontend shows graceful message
- **Model Selection:** Sonnet for core, Haiku for alerts

### ChatParseResponse (NLP Parse Result)

```typescript
// POST /api/v1/chat/{project_id}/message
// Request: { "message": "Bugün CW-01'de 5 adam çalıştı, 3 ünite bitti" }

interface ParsedAction {
  wbs_code: string;           // "CW-01"
  date: string;               // "2026-02-19" (YYYY-MM-DD)
  actual_manpower: number;    // 5
  qty_done: number;           // 3
  note?: string;              // optional note ("Çalışılmadı")
}

interface ChatParseResponse {
  message_id: string;          // UUID — chat_messages kaydının id'si
  actions: ParsedAction[];     // parse edilen aksiyonlar
  summary: string;             // "3 WBS güncellendi"
  confidence: number;          // 0.0 - 1.0 (0.7'nin altı → uyarı göster)
  applied: boolean;            // false (onay bekleniyor)
}
```

**Mock Data Örneği:**
```json
{
  "message_id": "msg-uuid-001",
  "actions": [
    { "wbs_code": "CW-01", "date": "2026-02-19", "actual_manpower": 5, "qty_done": 3, "note": null },
    { "wbs_code": "CW-02", "date": "2026-02-19", "actual_manpower": 7, "qty_done": 5, "note": null },
    { "wbs_code": "CW-03", "date": "2026-02-19", "actual_manpower": 0, "qty_done": 0, "note": "Çalışılmadı" }
  ],
  "summary": "3 cephe güncellendi",
  "confidence": 0.95,
  "applied": false
}
```

### ForecastResponse

```typescript
// POST /api/v1/ai/{project_id}/forecast

interface ForecastItem {
  wbs_code: string;
  wbs_name: string;
  current_progress: number;      // 0-100 %
  predicted_end_date: string;    // YYYY-MM-DD
  predicted_total_manday: number;
  risk_level: 'low' | 'medium' | 'high';
  recommendation: string;        // Türkçe doğal dil
}

interface ForecastResponse {
  forecasts: ForecastItem[];
  overall_summary: string;       // Türkçe doğal dil özet
  generated_at: string;          // ISO 8601 timestamp
}
```

**Mock Data Örneği:**
```json
{
  "forecasts": [
    {
      "wbs_code": "CW-01",
      "wbs_name": "Curtain Wall Tip-1",
      "current_progress": 35.0,
      "predicted_end_date": "2026-04-15",
      "predicted_total_manday": 120,
      "risk_level": "medium",
      "recommendation": "Mevcut hızda devam ederse 1 hafta gecikme riski var. KW12'den itibaren 2 ek adam önerilir."
    },
    {
      "wbs_code": "DR-01",
      "wbs_name": "Door Type-A",
      "current_progress": 60.0,
      "predicted_end_date": "2026-03-20",
      "predicted_total_manday": 45,
      "risk_level": "low",
      "recommendation": "İlerleme planın üzerinde, mevcut kaynakla sorunsuz tamamlanacak."
    }
  ],
  "overall_summary": "Genel ilerleme %42. CW-01 risk altında (1 hafta gecikme olasılığı). DR-01 ve GL-01 planın üzerinde. Toplam adam kaynağı yeterli, ancak CW-01'e redistribüsyon önerilir.",
  "generated_at": "2026-02-20T14:30:00Z"
}
```

### OptimizationResponse

```typescript
// POST /api/v1/ai/{project_id}/optimize

interface OptimizationResponse {
  suggestions: {
    wbs_code: string;
    current_manpower: number;
    suggested_manpower: number;
    delta: number;           // positive = add, negative = remove
    rationale: string;       // Türkçe
  }[];
  total_manpower_change: number;
  expected_impact: string;   // Türkçe doğal dil
  generated_at: string;
}
```

### WhatIfResponse

```typescript
// POST /api/v1/ai/{project_id}/whatif
// Request: { "scenario": "+5 adam KW10'dan itibaren" }

interface WhatIfResponse {
  scenario: string;
  impact: {
    wbs_code: string;
    current_end_date: string;
    projected_end_date: string;
    days_saved: number;
    manday_change: number;
  }[];
  overall_impact: string;     // Türkçe doğal dil
  feasibility: 'high' | 'medium' | 'low';
  generated_at: string;
}
```

### WeeklyReportResponse

```typescript
// GET /api/v1/ai/{project_id}/report

interface WeeklyReportResponse {
  report_markdown: string;    // Markdown formatted Türkçe rapor
  week_number: number;
  period: { from: string; to: string };
  generated_at: string;
}
```

### AI Error Codes

```typescript
// AI service error codes (HTTP 503 body)
type AIErrorCode =
  | 'AI_UNAVAILABLE'    // Claude API ulaşılamıyor
  | 'AI_PARSE_FAILED'   // NLP parse başarısız (invalid response)
  | 'AI_RATE_LIMITED'    // Rate limit aşıldı
  | 'AI_TOKEN_LIMIT'    // Token limiti aşıldı
  | 'AI_UNKNOWN_ERROR'; // Bilinmeyen hata

// Frontend graceful degradation:
// AI_UNAVAILABLE → "AI servisi şu an kullanılamıyor"
// AI_PARSE_FAILED → "Mesaj anlaşılamadı, lütfen tekrar deneyin veya manuel giriş yapın"
// AI_RATE_LIMITED → "Çok fazla istek, lütfen 1 dakika bekleyin"
// AI_TOKEN_LIMIT → "Mesaj çok uzun, lütfen kısaltın"
```

---

## IC-004: WBS Data Contract

- **Source of Truth:** Supabase `wbs_items` table (Agent 1 tarafından tanımlanır)
- **Shape:** WBSItem interface (IC-001'de tanımlı)
- **Used By:** All agents
- **Seed Data:** `supabase/seed.sql` → `{{WBS_DATA_PLACEHOLDER}}`

### WBS Code Format

```
Format: {CATEGORY}-{SEQ}
Örnekler:
  CW-01  → Curtain Wall Tip 1
  CW-02  → Curtain Wall Tip 2
  CW-03  → Curtain Wall Tip 3
  DR-01  → Door Type A
  DR-02  → Door Type B
  GL-01  → Glazing Type 1
  ST-01  → Steel Frame Tip 1
  CL-01  → Cladding Panel Tip 1

Hierarchy:
  Level 0: Bina / Ana Grup (is_summary = true)
  Level 1: Kat / Alt Grup (is_summary = true)
  Level 2: Cephe / İş Kalemi (is_summary = false, qty > 0)
```

### Test WBS Data

```json
[
  { "wbs_code": "CW-01", "wbs_name": "Curtain Wall Tip-1", "qty": 100, "unit": "m2", "level": 2 },
  { "wbs_code": "CW-02", "wbs_name": "Curtain Wall Tip-2", "qty": 150, "unit": "m2", "level": 2 },
  { "wbs_code": "CW-03", "wbs_name": "Curtain Wall Tip-3", "qty": 80, "unit": "m2", "level": 2 },
  { "wbs_code": "DR-01", "wbs_name": "Door Type-A", "qty": 50, "unit": "pcs", "level": 2 },
  { "wbs_code": "DR-02", "wbs_name": "Door Type-B", "qty": 30, "unit": "pcs", "level": 2 },
  { "wbs_code": "GL-01", "wbs_name": "Glazing Panel", "qty": 200, "unit": "m2", "level": 2 }
]
```

### WBS Validation Rules
- `wbs_code`: non-empty, matches `[A-Z]{2,3}-\d{2}` pattern
- `wbs_name`: non-empty
- `qty`: >= 0
- `unit`: non-empty
- `level`: >= 0
- `(project_id, wbs_code)` must be unique

---

## IC-005: Environment Variables

- **Defined By:** Agent 5 (DevOps)
- **Used By:** All agents
- **Master File:** `/.env.example`
- **Naming Convention:** See CONVENTIONS.md Section 6

### Full Variable List

```bash
# ===== Backend =====
# Supabase
SUPABASE_URL=https://your-project.supabase.co
SUPABASE_SERVICE_KEY=eyJ...your-service-key
DATABASE_URL=postgresql://postgres:postgres@localhost:5432/scheduling

# Claude AI
CLAUDE_API_KEY=sk-ant-your-api-key
CLAUDE_MODEL_DEFAULT=claude-sonnet-4-20250514
CLAUDE_MODEL_ALERT=claude-haiku-4-5-20251001
CLAUDE_MAX_TOKENS_PARSE=1000
CLAUDE_MAX_TOKENS_FORECAST=4000
CLAUDE_MAX_TOKENS_REPORT=2000
CLAUDE_RATE_LIMIT_PER_MINUTE=30

# App
ENVIRONMENT=development
CORS_ORIGINS=http://localhost:5173
LOG_LEVEL=INFO
API_VERSION=v1

# ===== Frontend =====
VITE_SUPABASE_URL=https://your-project.supabase.co
VITE_SUPABASE_ANON_KEY=eyJ...your-anon-key
VITE_API_BASE_URL=http://localhost:8000

# ===== Docker / DevOps =====
POSTGRES_PASSWORD=postgres
POSTGRES_DB=scheduling
POSTGRES_PORT=5432
BACKEND_PORT=8000
FRONTEND_PORT=5173
```

### Variable Ownership

| Variable | Owner Agent | Used By |
|----------|-------------|---------|
| SUPABASE_URL | Agent 1, Agent 5 | Agent 2, Agent 3 |
| SUPABASE_SERVICE_KEY | Agent 5 | Agent 2 |
| DATABASE_URL | Agent 5 | Agent 1, Agent 2 |
| CLAUDE_API_KEY | Agent 5 | Agent 4 |
| CLAUDE_MODEL_* | Agent 4 | Agent 4 |
| CORS_ORIGINS | Agent 5 | Agent 2 |
| VITE_* | Agent 5 | Agent 3 |
| POSTGRES_* | Agent 5 | Docker |

---

## Contract Change Protocol

```
1. Producer agent contract değişikliği yapmak istiyor
2. → Orchestrator'a bildirir: "IC-00X: [ne değişiyor] [neden]"
3. Orchestrator impact analizi yapar: hangi Consumer'lar etkileniyor?
4. Orchestrator onay verir → Producer değişikliği yapar
5. Bu dosya (INTERFACE_CONTRACTS.md) güncellenir
6. Etkilenen Consumer agent'lara bildirim gönderilir
7. Consumer agent'lar kendi kodlarını adapt eder
8. Integration test ile doğrulama
```

---

*Bu doküman Orchestrator Agent tarafından yönetilir. Contract değişikliği sadece Orchestrator onayı ile yapılabilir.*
